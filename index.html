<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cappy</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f4f4f9; }
        #header { padding: 10px 20px; background-color: #ffffff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        #header h1 { margin: 0; font-size: 1.2em; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        #model-selector { padding: 5px; border-radius: 5px; }
        #new-chat-button { background-color: #ff4d4d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 12px; max-width: 80%; line-height: 1.5; word-wrap: break-word; }
        .user-message { background-color: #007aff; color: white; align-self: flex-end; }
        .ai-message { background-color: #e5e5ea; color: #000; align-self: flex-start; }
        .error-message { background-color: #ffdddd; color: #d8000c; align-self: center; max-width: 90%; }
        .ai-message pre { background-color: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 5px; overflow-x: auto; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; background-color: #ffffff; }
        #input-text { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: none; font-size: 1em; font-family: inherit; }
        #send-button { margin-left: 10px; background-color: #34c759; color: white; border: none; padding: 0 20px; border-radius: 5px; cursor: pointer; }
        #send-button:disabled { background-color: #a9a9a9; }
    </style>
</head>
<body>
    <div id="header">
        <h1>Cappy <span>Beta</span></h1>
        <!-- 1. ADICIONA OS CONTROLES NO CABEÇALHO -->
        <div class="header-controls">
            <label for="model-selector">Modelo:</label>
            <select id="model-selector">
                <option value="llama3">Llama 3</option>
                <option value="codellama">Code Llama</option>
                <option value="gemma">Gemma</option>
                <!-- Adicione outros modelos que você tenha no Ollama -->
            </select>
            <button id="new-chat-button">Limpar Conversa</button>
        </div>
    </div>
    <div id="chat-container"></div>
    <div id="input-area">
        <textarea id="input-text" placeholder="Digite sua mensagem... (Shift+Enter para enviar)" rows="1"></textarea>
        <button id="send-button">Enviar</button>
    </div>
    <script>
        const sendButton = document.getElementById('send-button');
        const newChatButton = document.getElementById('new-chat-button');
        const inputText = document.getElementById('input-text');
        const chatContainer = document.getElementById('chat-container');
        const modelSelector = document.getElementById('model-selector'); // Pega o seletor

        let conversationHistory = [];
        let isStreaming = false;

        function addMessageToUI(sender, text, isError = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (isError) {
                messageElement.classList.add('error-message');
                messageElement.innerHTML = text;
            } else {
                messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
                messageElement.innerHTML = sender === 'ai' ? marked.parse(text) : text;
            }
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageElement;
        }

        async function handleSend() {
            // CORREÇÃO BUG 1: Garante que texto vazio não seja enviado.
            if (isStreaming) return;
            const userText = inputText.value.trim();
            if (!userText) return;

            isStreaming = true;
            sendButton.disabled = true;
            inputText.value = "";
            inputText.style.height = 'auto';

            conversationHistory.push({ role: 'user', content: userText });
            addMessageToUI('user', userText);
            
            let aiMessageElement = addMessageToUI('ai', '...');
            let fullResponse = "";
            let errorOccurred = false;

            try {
                // 2. USA O VALOR DO SELETOR
                const selectedModel = modelSelector.value;
                await window.api.streamText(
                    conversationHistory,
                    selectedModel,
                    (data) => {
                        if (data.error) {
                            errorOccurred = true;
                            addMessageToUI(null, `<strong>Erro do Modelo:</strong> ${data.error}`, true);
                            return;
                        }
                        if (data.message?.content) {
                            if (aiMessageElement.innerHTML.includes('...')) aiMessageElement.innerHTML = '';
                            fullResponse += data.message.content;
                            aiMessageElement.innerHTML = marked.parse(fullResponse);
                        }
                    },
                    (error) => {
                        errorOccurred = true;
                        addMessageToUI(null, `<strong>Erro de Comunicação:</strong> ${error}`, true);
                    },
                    () => {
                        if (!errorOccurred) {
                            conversationHistory.push({ role: 'assistant', content: fullResponse });
                            window.api.setStore('conversationHistory', conversationHistory);
                        }
                    }
                );
            } catch (e) {
                addMessageToUI(null, `<strong>Erro Crítico:</strong> ${e.message}`, true);
            } finally {
                isStreaming = false;
                sendButton.disabled = false;
                inputText.focus();
            }
        }
        
        async function loadSettings() {
            // 3. CARREGA AS CONFIGURAÇÕES SALVAS (histórico e modelo)
            const savedHistory = await window.api.getStore('conversationHistory');
            if (savedHistory && Array.isArray(savedHistory)) {
                conversationHistory = savedHistory;
                chatContainer.innerHTML = '';
                conversationHistory.forEach(message => {
                    addMessageToUI(message.role === 'assistant' ? 'ai' : 'user', message.content);
                });
            }
            const savedModel = await window.api.getStore('selectedModel');
            if (savedModel) {
                modelSelector.value = savedModel;
            }
        }

        // --- EVENT LISTENERS ---
        newChatButton.addEventListener('click', () => {
            conversationHistory = [];
            chatContainer.innerHTML = '';
            window.api.setStore('conversationHistory', []);
            isStreaming = false;
            sendButton.disabled = false;
            inputText.focus();
        });

        modelSelector.addEventListener('change', () => {
            // 4. SALVA A ESCOLHA DO MODELO QUANDO ELA MUDA
            window.api.setStore('selectedModel', modelSelector.value);
        });

        sendButton.addEventListener('click', handleSend);
        inputText.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                handleSend();
            }
        });
        document.addEventListener('DOMContentLoaded', loadSettings);

    </script>
</body>
</html>